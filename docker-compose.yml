# ═══════════════════════════════════════════════════════════════════════════════
# GitHub Backup - Docker Compose
# ═══════════════════════════════════════════════════════════════════════════════
# Automated GitHub repository backup to S3-compatible storage
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   Scheduler mode:     docker compose up -d
#   Immediate backup:   docker compose run --rm github-backup --now
#   CLI commands:       docker compose run --rm github-backup cli <command>
#
# ═══════════════════════════════════════════════════════════════════════════════

services:

  # ─────────────────────────────────────────────────────────────────────────────
  # GitHub Backup Service
  # ─────────────────────────────────────────────────────────────────────────────
  github-backup:
    build:
      context: ./src
      dockerfile: Dockerfile
    container_name: ${STACK_NAME:-github-backup}
    environment:
      # ─── GitHub ───
      - GITHUB_OWNER=${GITHUB_OWNER}
      - GITHUB_PAT=${GITHUB_PAT}
      - GITHUB_BACKUP_PRIVATE=${GITHUB_BACKUP_PRIVATE:-true}
      - GITHUB_BACKUP_FORKS=${GITHUB_BACKUP_FORKS:-false}
      - GITHUB_BACKUP_ARCHIVED=${GITHUB_BACKUP_ARCHIVED:-true}
      # ─── Backup ───
      - BACKUP_RETENTION_COUNT=${BACKUP_RETENTION_COUNT:-7}
      - BACKUP_INCLUDE_METADATA=${BACKUP_INCLUDE_METADATA:-true}
      - BACKUP_INCLUDE_WIKI=${BACKUP_INCLUDE_WIKI:-true}
      - BACKUP_INCREMENTAL=${BACKUP_INCREMENTAL:-true}
      # ─── Scheduler ───
      - BACKUP_SCHEDULE_ENABLED=${BACKUP_SCHEDULE_ENABLED:-true}
      - BACKUP_SCHEDULE_MODE=${BACKUP_SCHEDULE_MODE:-daily}
      - BACKUP_SCHEDULE_HOUR=${BACKUP_SCHEDULE_HOUR:-2}
      - BACKUP_SCHEDULE_MINUTE=${BACKUP_SCHEDULE_MINUTE:-0}
      - BACKUP_SCHEDULE_DAY_OF_WEEK=${BACKUP_SCHEDULE_DAY_OF_WEEK:-*}
      - BACKUP_SCHEDULE_INTERVAL_HOURS=${BACKUP_SCHEDULE_INTERVAL_HOURS:-24}
      # ─── S3/MinIO ───
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_MULTIPART_THRESHOLD=${S3_MULTIPART_THRESHOLD:-104857600}
      - S3_MULTIPART_CHUNK_SIZE=${S3_MULTIPART_CHUNK_SIZE:-52428800}
      # ─── Alerting ───
      - ALERT_ENABLED=${ALERT_ENABLED:-false}
      - ALERT_LEVEL=${ALERT_LEVEL:-errors}
      - ALERT_CHANNELS=${ALERT_CHANNELS:-}
      # SMTP
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_TLS=${SMTP_TLS:-true}
      - SMTP_SSL=${SMTP_SSL:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-GitHub Backup}
      - SMTP_TO=${SMTP_TO:-}
      # Webhook
      - WEBHOOK_URL=${WEBHOOK_URL:-}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      # Teams
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL:-}
      # ─── Application ───
      - TZ=${TZ:-Etc/UTC}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - backup-data:/data
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ───────────────────────────────────────────────────────────────────────────────
# Volumes
# ───────────────────────────────────────────────────────────────────────────────
volumes:
  backup-data:
    name: ${STACK_NAME:-github-backup}-data
